var t=Object.defineProperty,e=(e,i,s)=>((e,i,s)=>i in e?t(e,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[i]=s)(e,"symbol"!=typeof i?i+"":i,s);import{p as i}from"./phaser-CwoquCe3.js";!function(){const t=document.createElement("link").relList;if(!(t&&t.supports&&t.supports("modulepreload"))){for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver((t=>{for(const i of t)if("childList"===i.type)for(const t of i.addedNodes)"LINK"===t.tagName&&"modulepreload"===t.rel&&e(t)})).observe(document,{childList:!0,subtree:!0})}function e(t){if(t.ep)return;t.ep=!0;const e=function(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerPolicy&&(e.referrerPolicy=t.referrerPolicy),"use-credentials"===t.crossOrigin?e.credentials="include":"anonymous"===t.crossOrigin?e.credentials="omit":e.credentials="same-origin",e}(t);fetch(t.href,e)}}();const s=[40,100,300,1200],r={T:[[0,2,0],[2,2,2],[0,0,0]],O:[[3,3],[3,3]],L:[[0,0,5],[5,5,5],[0,0,0]],J:[[4,0,0],[4,4,4],[0,0,0]],I:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],S:[[0,7,7],[7,7,0],[0,0,0]],Z:[[6,6,0],[0,6,6],[0,0,0]]},a=Object.keys(r),l={"0->R":[[0,0],[-1,0],[-1,1],[0,-2],[-1,-2]],"R->0":[[0,0],[1,0],[1,-1],[0,2],[1,2]],"R->2":[[0,0],[1,0],[1,-1],[0,2],[1,2]],"2->R":[[0,0],[-1,0],[-1,1],[0,-2],[-1,-2]],"2->L":[[0,0],[1,0],[1,1],[0,-2],[1,-2]],"L->2":[[0,0],[-1,0],[-1,-1],[0,2],[-1,2]],"L->0":[[0,0],[-1,0],[-1,-1],[0,2],[-1,2]],"0->L":[[0,0],[1,0],[1,1],[0,-2],[1,-2]]},h={"0->R":[[0,0],[-2,0],[1,0],[-2,-1],[1,2]],"R->0":[[0,0],[2,0],[-1,0],[2,1],[-1,-2]],"R->2":[[0,0],[-1,0],[2,0],[-1,2],[2,-1]],"2->R":[[0,0],[1,0],[-2,0],[1,-2],[-2,1]],"2->L":[[0,0],[2,0],[-1,0],[2,1],[-1,-2]],"L->2":[[0,0],[-2,0],[1,0],[-2,-1],[1,2]],"L->0":[[0,0],[1,0],[-2,0],[1,-2],[-2,1]],"0->L":[[0,0],[-1,0],[2,0],[-1,2],[2,-1]]};class n{constructor(t){e(this,"bag",[]),this.blockTypes=t}shuffleBag(){this.bag=[...this.blockTypes];for(let t=this.bag.length-1;t>0;t--){const e=Math.floor(Math.random()*(t+1));[this.bag[t],this.bag[e]]=[this.bag[e],this.bag[t]]}}generatePiece(){return 0===this.bag.length&&this.shuffleBag(),this.bag.pop()}}function o(t,e){if(!t)return null;const i=structuredClone(t);for(let s=0;s<i.length;++s)for(let t=0;t<s;++t)[i[t][s],i[s][t]]=[i[s][t],i[t][s]];return"CW"===e?i.forEach((t=>t.reverse())):i.reverse(),i}class p{constructor(t=0){e(this,"level",0),e(this,"linesCleared",0),e(this,"currentSpeed",800),this.level=t,this.updateSpeed()}addClearedLines(t){this.linesCleared+=t;const e=this.level<10?10*(this.level+1):100+10*(this.level-9);this.linesCleared>=e&&(this.level++,this.updateSpeed())}updateSpeed(){let t;t=this.level<=8?[48,43,38,33,28,23,18,13,8][this.level]:9===this.level?6:this.level<=12?5:this.level<=15?4:this.level<=18?3:this.level<=28?2:1,this.currentSpeed=t/60*1e3}}class d extends i.Scene{constructor(){super("Game"),e(this,"playAreaX",0),e(this,"playAreaY",20),e(this,"lastUpdateTime",0),e(this,"gravity",null),e(this,"gameSpeed",-1),e(this,"softDropSpeed",20),e(this,"downKeyPressTime",0),e(this,"softDropping",!1),e(this,"softDropDelay",100),e(this,"das",150),e(this,"arr",30),e(this,"moveDirection",null),e(this,"keyPressTime",0),e(this,"lastMoveTime",0),e(this,"bgMusic"),e(this,"cursors"),e(this,"zKey"),e(this,"spaceKey"),e(this,"canRotate",!0),e(this,"inputLocked",!1),e(this,"grid",Array.from({length:20},(()=>Array(10).fill(0)))),e(this,"playerSprite",null),e(this,"playerRow",0),e(this,"playerCol",0),e(this,"playerRotation","0"),e(this,"playerType",null),e(this,"playerMatrix",null),e(this,"gridBlocks",[]),e(this,"pauseGame",!1),e(this,"showGridLines",!1),e(this,"gameOver",!1),e(this,"downKeyReleased",!0),e(this,"pieceGenerator",new n(a)),e(this,"nextPieces",[]),e(this,"nextPiecesSprites",[]),e(this,"score",0),e(this,"level",0),e(this,"initialLevel",0),e(this,"totalLines",0),e(this,"scoreText",null),e(this,"levelText",null),e(this,"linesText",null),e(this,"btnLeft",null),e(this,"btnLeftPressed",!1),e(this,"btnRight",null),e(this,"btnRightPressed",!1),e(this,"btnDrop",null),e(this,"btnDropPressed",!1),e(this,"btnRotate",null)}preload(){this.load.atlas("tetrominos","assets/tetris-blocks2.png","assets/tetris-blocks2.json"),this.load.spritesheet("tiles","assets/tetris-tiles2.png",{frameWidth:32,frameHeight:32}),this.load.audio("tetrisMusic","/phaser-tetris/assets/tetris-theme-3uvX0fkN.mp3"),this.load.image("background","assets/background.png"),this.load.bitmapFont("arcade","assets/arcade.png","assets/arcade.xml")}create(){var t,e,i,s;this.score=0,this.lastUpdateTime=0,this.level=this.initialLevel,this.gravity=new p(this.initialLevel),this.gameSpeed=this.gravity.currentSpeed,this.setupWorld(),this.setupMusic(),this.cursors=null==(t=this.input.keyboard)?void 0:t.createCursorKeys(),this.zKey=null==(e=this.input.keyboard)?void 0:e.addKey(Phaser.Input.Keyboard.KeyCodes.Z),null==(s=null==(i=this.input)?void 0:i.keyboard)||s.on("keydown-SPACE",(()=>{!this.inputLocked&&this.playerSprite&&this.handleHardDrop()})),this.nextPieces.push(this.pieceGenerator.generatePiece()),this.newBlock()}setupMusic(){this.bgMusic=this.sound.add("tetrisMusic"),this.bgMusic.loop=!0}setupWorld(){const t=320;if(this.playAreaX=20,this.add.rectangle(this.playAreaX,this.playAreaY,324,644,0).setOrigin(0,0),this.add.rectangle(this.playAreaX+t+20,this.playAreaY,150,324,0).setOrigin(0,0),this.add.bitmapText(this.playAreaX+t+40,this.playAreaY+20,"arcade","Score",18).setOrigin(0,0).setTint(16769126),this.scoreText=this.add.bitmapText(this.playAreaX+t+40,this.playAreaY+45,"arcade",String(this.score),18).setOrigin(0,0).setTint(16777215),this.add.bitmapText(this.playAreaX+t+40,this.playAreaY+80,"arcade","Next",18).setOrigin(0,0).setTint(16769126),this.add.bitmapText(this.playAreaX+t+40,this.playAreaY+200,"arcade","Level",18).setOrigin(0,0).setTint(16769126),this.levelText=this.add.bitmapText(this.playAreaX+t+40,this.playAreaY+225,"arcade",String(this.level),18).setOrigin(0,0).setTint(16777215),this.add.bitmapText(this.playAreaX+t+40,this.playAreaY+260,"arcade","Lines",18).setOrigin(0,0).setTint(16769126),this.linesText=this.add.bitmapText(this.playAreaX+t+40,this.playAreaY+285,"arcade",String(this.totalLines),18).setOrigin(0,0).setTint(16777215),this.btnLeft=this.add.circle(this.playAreaX+10,690,60,16711680).setOrigin(0,0).setInteractive(),this.btnLeft.on("pointerdown",(()=>{this.btnLeftPressed=!0})),this.btnLeft.on("pointerup",(()=>{this.btnLeftPressed=!1})),this.btnRight=this.add.circle(this.playAreaX+170,690,60,65280).setOrigin(0,0).setInteractive(),this.btnRight.on("pointerdown",(()=>{this.btnRightPressed=!0})),this.btnRight.on("pointerup",(()=>{this.btnRightPressed=!1})),this.btnDrop=this.add.circle(this.playAreaX+90,800,60,255).setOrigin(0,0).setInteractive(),this.btnDrop.on("pointerdown",(()=>{this.btnDropPressed=!0})),this.btnDrop.on("pointerup",(()=>{this.btnDropPressed=!1})),this.btnRotate=this.add.circle(this.playAreaX+340,690,70,16776960).setOrigin(0,0).setInteractive(),this.btnRotate.on("pointerdown",(()=>{this.renderPlayer("rotate","CW")})),this.showGridLines){for(let t=1;t<10;t++){const e=32*t;this.add.line(this.playAreaX,this.playAreaY,e,0,e,640,2236962).setOrigin(0,0)}for(let t=1;t<20;t++){const e=32*t;this.add.line(this.playAreaX,this.playAreaY,0,e,320,e,2236962).setOrigin(0,0)}}}checkCollision(){var t,e;if(!this.playerMatrix)return!1;for(let i=0;i<this.playerMatrix.length;i++)for(let s=0;s<this.playerMatrix[i].length;s++)if(0!==this.playerMatrix[i][s]&&(void 0===(null==(t=this.grid[this.playerRow+i])?void 0:t[this.playerCol+s])||0!==(null==(e=this.grid[this.playerRow+i])?void 0:e[this.playerCol+s])))return!0;return!1}addPlayerToGrid(){var t,e,i,s;if(this.playerMatrix){if(0===this.playerRow)return!1;for(let r=0;r<this.playerMatrix.length;r++)for(let a=0;a<this.playerMatrix[r].length;a++)if(0!==this.playerMatrix[r][a]){const l=(null==(t=this.playerMatrix[r-1])?void 0:t[a])??0,h=(null==(e=this.playerMatrix[r])?void 0:e[a+1])??0,n=(null==(i=this.playerMatrix[r+1])?void 0:i[a])??0,o=(null==(s=this.playerMatrix[r])?void 0:s[a-1])??0;this.grid[this.playerRow+r][this.playerCol+a]=[l,h,n,o]}return!0}}updateScore(t){var e,i,r;t>0&&(this.totalLines+=t,this.score+=s[t-1]*(this.level+1),this.level=Math.floor(this.totalLines/10)+this.initialLevel,this.gravity&&(this.gravity.addClearedLines(t),this.gameSpeed=this.gravity.currentSpeed),null==(e=this.scoreText)||e.setText(`${this.score}`),null==(i=this.levelText)||i.setText(`${this.level}`),null==(r=this.linesText)||r.setText(`${this.totalLines}`))}clearCompletedLines(t){let e=0;const i=[];for(let s=0;s<20;s++){let t=0;for(let e=0;e<10;e++)this.grid[s][e]&&(t+=1);10===t&&(e+=1,i.push(s))}return this.updateScore(e),this.pauseGame=!0,this.time.delayedCall(e?100+100*e:10,(()=>{var e;this.gameOver||(i.forEach((t=>{var e;for(let i=0;i<10;i++){if(Array.isArray(this.grid[t-1][i])&&4===this.grid[t-1][i].length){const e=this.grid[t-1][i].flat().filter(Boolean)[0];this.grid[t-1][i][2]=0,0===this.grid[t-1][i].flat().filter(Boolean).length&&(this.grid[t-1][i]=[e])}if(Array.isArray(null==(e=this.grid[t+1])?void 0:e[i])&&4===this.grid[t+1][i].length){const e=this.grid[t+1][i].flat().filter(Boolean)[0];this.grid[t+1][i][0]=0,0===this.grid[t+1][i].flat().filter(Boolean).length&&(this.grid[t+1][i]=[e])}}})),i.forEach((t=>{this.grid.splice(t,1),this.grid.unshift(Array(10).fill(0))})),null==(e=this.playerSprite)||e.destroy(),this.playerSprite=null,this.newBlock(),this.renderGridBlocks(),this.pauseGame=!1,this.inputLocked=!1,null==t||t())})),this.downKeyPressTime=0,this.softDropping=!1,e}newBlock(){const t=this.nextPieces.shift();if(!t)return;this.playerType=t,this.playerRotation="0",this.playerRow=0,this.playerCol=3,this.playerMatrix=r[this.playerType];let e=!1;this.checkCollision()&&(e=!0),this.renderPlayerSprite(),e&&this.lockPiece(),this.lastUpdateTime=this.time.now}renderPlayerSprite(){const t=`${this.playerType}-${this.playerRotation}`;let e=this.playerCol,i=this.playerRow;"I"===this.playerType?"0"===this.playerRotation?i+=1:"R"===this.playerRotation?e+=2:"2"===this.playerRotation?i+=2:"L"===this.playerRotation&&(e+=1):"J"!==this.playerType&&"L"!==this.playerType&&"T"!==this.playerType&&"S"!==this.playerType&&"Z"!==this.playerType||("R"===this.playerRotation?e+=1:"2"===this.playerRotation&&(i+=1)),this.playerSprite?(this.playerSprite.setFrame(t),this.playerSprite.setX(8*e*4+this.playAreaX),this.playerSprite.setY(8*i*4+this.playAreaY)):this.playerSprite=this.add.sprite(8*e*4+this.playAreaX,8*i*4+this.playAreaY,"tetrominos",t).setOrigin(0,0)}canPlacePieceAt(t,e){if(!this.playerMatrix)return!1;for(let i=0;i<this.playerMatrix.length;i++)for(let s=0;s<this.playerMatrix[i].length;s++)if(0!==this.playerMatrix[i][s]&&(void 0===this.grid[e+i]||0!==this.grid[e+i][t+s]))return!1;return!0}renderPlayer(t,e="CW"){let i=!1;if("right"===t)this.playerCol+=1,this.checkCollision()&&(i=!0,this.playerCol-=1);else if("left"===t)this.playerCol-=1,this.checkCollision()&&(i=!0,this.playerCol+=1);else if("down"===t)this.playerRow+=1,this.checkCollision()&&(i=!0,this.playerRow-=1);else if("rotate"===t){const t=this.playerRotation,s=function(t,e){if("CW"===e){if("0"===t)return"R";if("R"===t)return"2";if("2"===t)return"L";if("L"===t)return"0"}else{if("0"===t)return"L";if("L"===t)return"2";if("2"===t)return"R";if("R"===t)return"0"}return t}(this.playerRotation,e),r="I"===this.playerType?h:l,a=`${t}->${s}`;this.playerMatrix=o(this.playerMatrix,e),i=!0;for(const[e,l]of r[a]){const t=this.playerCol+e,r=this.playerRow+l;if(this.canPlacePieceAt(t,r)&&(this.playerCol=t,this.playerRow=r,this.playerRotation=s,!this.checkCollision())){i=!1;break}}i&&(this.playerMatrix=o(this.playerMatrix,"CW"===e?"CCW":"CW"),this.playerRotation=t)}return this.renderPlayerSprite(),i}renderGridBlocks(){this.gridBlocks.forEach((t=>t.destroy()));for(let t=0;t<this.grid.length;t++)for(let e=0;e<this.grid[t].length;e++)if(0!==this.grid[t][e]&&Array.isArray(this.grid[t][e])){const i=this.grid[t][e][0],s=this.grid[t][e][1],r=this.grid[t][e][2],a=this.grid[t][e][3];let l=14;4===this.grid[t][e].length&&(i||!s||r||a?!i&&s&&!r&&a?l=1:i||s||r||!a?i||s||!r||a?i&&!s&&r&&!a?l=4:!i||s||r||a?i&&s&&!r&&a?l=6:i&&s&&r&&!a?l=7:!i&&s&&r&&a?l=8:i&&!s&&r&&a?l=9:!i&&s&&r&&!a?l=10:i&&!s&&!r&&a?l=11:i&&s&&!r&&!a?l=12:!i&&!s&&r&&a?l=13:i||s||r||a||(l=14):l=5:l=3:l=2:l=0);const h=(this.grid[t][e].flat().filter(Boolean)[0]??8)-1,n=this.add.sprite(8*e*4+this.playAreaX,8*t*4+this.playAreaY,"tiles",l+15*h).setOrigin(0,0);this.gridBlocks.push(n)}}handleHorizontalMove(t){var e,i;const s=(null==(e=this.cursors)?void 0:e.left.isDown)||this.btnLeftPressed,r=(null==(i=this.cursors)?void 0:i.right.isDown)||this.btnRightPressed;if(s||r){const e=s?"left":"right";if(this.moveDirection!==e)this.moveDirection=e,this.keyPressTime=t,this.lastMoveTime=t,this.renderPlayer(e);else{const i=t-this.keyPressTime,s=t-this.lastMoveTime;i>=this.das&&s>=this.arr&&(this.lastMoveTime=t,this.renderPlayer(e))}}else this.moveDirection=null,this.keyPressTime=0,this.lastMoveTime=0}handleHardDrop(){this.inputLocked=!0;const t=this.playerRow;let e=this.playerRow;for(;;)if(e+=1,this.playerRow=e,this.checkCollision()){e-=1;break}const i=e,s=i-t,r=Phaser.Math.Clamp(10*s,50,200);this.tweens.add({targets:this.playerSprite,y:8*i*4+this.playAreaY,duration:r,ease:"Quad.easeIn",onComplete:()=>{this.playerRow=i,this.addPlayerToGrid()||(this.playerRow+=1,this.renderPlayerSprite(),this.gameOver=!0),this.clearCompletedLines((()=>{this.inputLocked=!1}))}})}lockPiece(){this.inputLocked=!0,this.addPlayerToGrid()||(this.renderPlayerSprite(),this.gameOver=!0),this.clearCompletedLines((()=>{this.downKeyReleased=!1}))}handleVerticalMove(t){var e;if((null==(e=this.cursors)?void 0:e.down.isDown)||this.btnDropPressed){if(!this.downKeyReleased)return;if(0===this.downKeyPressTime){if(this.lastUpdateTime=t,this.downKeyPressTime=t,this.softDropping=!1,this.renderPlayer("down"))return void this.lockPiece()}else t-this.downKeyPressTime>this.softDropDelay&&(this.softDropping=!0)}else this.downKeyPressTime=0,this.softDropping=!1,this.downKeyReleased=!0;const i=this.softDropping?this.softDropSpeed:this.gameSpeed;t>this.lastUpdateTime+i&&(this.lastUpdateTime=t,this.renderPlayer("down")&&this.lockPiece())}handleRotationalMove(){var t,e,i,s;(null==(t=this.cursors)?void 0:t.up.isDown)&&this.canRotate&&(this.canRotate=!1,this.renderPlayer("rotate","CW")),(null==(e=this.zKey)?void 0:e.isDown)&&this.canRotate&&(this.canRotate=!1,this.renderPlayer("rotate","CCW")),(null==(i=this.cursors)?void 0:i.up.isUp)&&(null==(s=this.zKey)?void 0:s.isUp)&&!this.canRotate&&(this.canRotate=!0)}renderNextPieces(){if(this.nextPieces.length<1){for(;this.nextPieces.length<1;)this.nextPieces.push(this.pieceGenerator.generatePiece());this.nextPiecesSprites.forEach((t=>t.destroy()));const t=320;for(let e=0;e<this.nextPieces.length;e++){const i=`${this.nextPieces[e]}-0`;this.nextPiecesSprites.push(this.add.sprite(this.playAreaX+t+40,130+80*e,"tetrominos",i).setScale(.7).setOrigin(0,0))}}}update(t){this.pauseGame||this.gameOver||this.inputLocked||(this.handleHorizontalMove(t),this.handleVerticalMove(t),this.handleRotationalMove(),this.renderNextPieces())}}const c={type:i.AUTO,width:530,height:930,parent:"game",backgroundColor:"#333",scale:{mode:i.Scale.FIT,autoCenter:i.Scale.CENTER_BOTH},antialias:!0,scene:[d]};new i.Game(c);
